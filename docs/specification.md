# AI-OCR システム仕様書

## 1. はじめに

本文書は、AI-OCR システムの詳細仕様を記述したものです。このシステムは、Microsoft Office Excel 文書から AI を用いて構造化データを抽出するための社内リソースとして設計されています。

### 1.1. 目的

本システムの目的は以下の通りです：

- Excel ファイルから構造化データを高精度に抽出する
- 抽出プロセスを自動化し、手作業によるデータ入力の負担を軽減する
- 一貫した形式でデータを保存し、他システムとの連携を容易にする
- スケーラブルな処理能力を提供し、大量の文書を効率的に処理する

### 1.2. 用語定義

| 用語         | 説明                                           |
| ------------ | ---------------------------------------------- |
| 文書         | 処理対象となる Excel ファイル                  |
| ジョブ       | 文書の処理タスク                               |
| 抽出         | 文書からのデータ抽出処理とその結果             |
| AI モデル    | データ抽出に使用される GPT-4o などの言語モデル |
| パーサー     | 特定の文書形式を解析するためのコンポーネント   |
| バリデーター | 抽出されたデータの検証を行うコンポーネント     |

## 2. 機能要件

### 2.1. 文書管理機能

#### 2.1.1. 文書アップロード

- Excel ファイル (.xlsx, .xls, .csv) をアップロード可能
- ファイルサイズの制限: 最大 50MB
- アップロード時に基本的なファイル検証を実施
- 一意の ID で文書を識別
- メタデータ（ファイル名、サイズ、タイプなど）を記録

#### 2.1.2. 文書ステータス管理

- 文書の処理状態を追跡: `uploaded`, `processing`, `processed`, `failed`
- 文書メタデータの取得
- 文書一覧の取得と検索
- 文書の削除とアーカイブ

### 2.2. 処理ジョブ管理

#### 2.2.1. ジョブ作成と制御

- 特定の文書に対する処理ジョブの作成
- ジョブの進行状況の追跡: `pending`, `processing`, `completed`, `failed`, `canceled`
- ジョブの進捗率の把握 (0-100%)
- ジョブのキャンセル

#### 2.2.2. ジョブスケジューリング

- ジョブキューによる非同期処理
- 優先度に基づくジョブの順序付け
- 処理リソースの分散制御

### 2.3. データ抽出機能

#### 2.3.1. Excel データ解析

- 複数シートの処理
- 表形式データの認識と構造化
- セル結合や書式の解釈
- 数式の処理と結果の取得

#### 2.3.2. AI を活用したデータ抽出

- GPT-4o による文書内容の理解
- LangChain/LangGraph を使用した抽出パイプライン
- コンテキストに基づくデータの解釈
- 高い精度での情報抽出

#### 2.3.3. データバリデーション

- 抽出データの構造検証
- データ型と範囲の検証
- ビジネスルールに基づく整合性検証
- 不確かなデータのフラグ付け

### 2.4. データ出力と統合

#### 2.4.1. データ形式

- JSON 形式での標準出力
- 構造化されたデータモデル
- メタデータと信頼度スコアの付加

#### 2.4.2. API 連携

- RESTful API によるデータアクセス
- 他システムとの統合インターフェース
- バッチ処理のサポート

## 3. 非機能要件

### 3.1. パフォーマンス要件

#### 3.1.1. 処理時間

- 標準的な Excel ファイル (1MB 未満) の処理: 30 秒以内
- 複雑な Excel ファイル (1-10MB): 2 分以内
- 大規模 Excel ファイル (10-50MB): 5 分以内

#### 3.1.2. スループット

- 同時処理可能なジョブ数: 10 件 (標準構成)
- 1 日あたりの処理可能数: 1,000 件以上 (標準構成)
- ピーク時の処理能力: 通常の 3 倍のリクエスト量に対応

#### 3.1.3. スケーラビリティ

- 水平スケーリングによる処理能力の向上
- 負荷に応じたリソース割り当ての調整
- 処理ワーカー数の動的な調整

### 3.2. 信頼性要件

#### 3.2.1. 可用性

- サービス稼働率: 99.5% 以上 (計画的なメンテナンスを除く)
- 計画外のダウンタイム: 月間 4 時間未満

#### 3.2.2. 耐障害性

- 単一障害点のない設計
- コンポーネント障害時の自動復旧
- 処理の冪等性確保によるリカバリー

#### 3.2.3. バックアップと復旧

- データベースの日次バックアップ
- ポイントインタイムリカバリー (24 時間以内)
- ストレージデータの定期バックアップ

### 3.3. セキュリティ要件

#### 3.3.1. 認証と認可

- トークンベースの API 認証
- ロールベースのアクセス制御
- 認証情報の暗号化

#### 3.3.2. データ保護

- 保存データの暗号化
- 通信の TLS 暗号化 (プロダクション環境)
- センシティブデータの適切な処理

#### 3.3.3. 監査とログ

- アクセスログの記録
- 操作ログの保持 (90 日間)
- セキュリティイベントの監視と通知

### 3.4. 保守性要件

#### 3.4.1. 監視と運用

- 各サービスの健全性監視
- リソース使用率の監視
- エラー率とパフォーマンスメトリクスの収集

#### 3.4.2. 設定管理

- 環境変数による設定
- 環境別設定の分離
- 動的な設定変更のサポート

#### 3.4.3. アップデート

- ダウンタイム最小化のアップデート方式
- ローリングアップデートのサポート
- バージョン間の互換性確保

## 4. データモデル

### 4.1. 主要エンティティ

#### 4.1.1. Document

```json
{
  "id": "UUID",
  "filename": "string",
  "file_type": "string",
  "file_size": "integer",
  "file_path": "string",
  "status": "string",
  "metadata": "JSON",
  "uploaded_at": "timestamp",
  "updated_at": "timestamp",
  "error": "string"
}
```

#### 4.1.2. Job

```json
{
  "id": "UUID",
  "document_id": "UUID",
  "status": "string",
  "progress": "float",
  "created_at": "timestamp",
  "updated_at": "timestamp",
  "completed_at": "timestamp",
  "error": "string"
}
```

#### 4.1.3. Extraction

```json
{
  "id": "UUID",
  "job_id": "UUID",
  "document_id": "UUID",
  "extracted_data": "JSON",
  "confidence_score": "float",
  "format_type": "string",
  "validation_results": "JSON",
  "extracted_at": "timestamp",
  "created_at": "timestamp",
  "updated_at": "timestamp",
  "notes": "string"
}
```

### 4.2. リレーションシップ

- Document (1) → Job (N): 1 つの文書に対して複数のジョブが存在可能
- Job (1) → Extraction (1): 1 つのジョブに対して 1 つの抽出結果が存在
- Document (1) → Extraction (N): 1 つの文書に対して複数の抽出結果が存在可能

### 4.3. 状態遷移

#### 4.3.1. Document 状態遷移

```
uploaded → processing → processed
           ↓
           failed
```

#### 4.3.2. Job 状態遷移

```
pending → processing → completed
  ↓         ↓
canceled   failed
```

## 5. API 仕様

API の詳細仕様は [API エンドポイント仕様](api/endpoints.md) を参照してください。以下はその概要です。

### 5.1. API エンドポイント構成

| リソース | メソッド | エンドポイント                      | 説明               |
| -------- | -------- | ----------------------------------- | ------------------ |
| 文書     | POST     | /api/v1/documents                   | 文書のアップロード |
| 文書     | GET      | /api/v1/documents                   | 文書一覧の取得     |
| 文書     | GET      | /api/v1/documents/{document_id}     | 特定文書の取得     |
| 文書     | DELETE   | /api/v1/documents/{document_id}     | 文書の削除         |
| ジョブ   | POST     | /api/v1/jobs                        | ジョブの作成       |
| ジョブ   | GET      | /api/v1/jobs                        | ジョブ一覧の取得   |
| ジョブ   | GET      | /api/v1/jobs/{job_id}               | 特定ジョブの取得   |
| ジョブ   | POST     | /api/v1/jobs/{job_id}/cancel        | ジョブのキャンセル |
| 抽出     | GET      | /api/v1/extractions/{extraction_id} | 抽出結果の取得     |
| 抽出     | GET      | /api/v1/extractions                 | 抽出結果一覧の取得 |

### 5.2. 認証

- Bearer トークン認証
- HTTP ヘッダー: `Authorization: Bearer <TOKEN>`
- トークン有効期限: 24 時間 (デフォルト設定)

### 5.3. エラーレスポンス

標準エラーレスポンス形式:

```json
{
  "error": {
    "code": "string",
    "message": "string",
    "details": "object"
  }
}
```

## 6. データ処理フロー

### 6.1. 文書アップロードフロー

1. クライアントが API サービスに文書をアップロード
2. API サービスがファイルバリデーションを実施
3. ファイルが MinIO に保存される
4. 文書メタデータがデータベースに登録される
5. 処理ジョブが作成され、Redis キューに追加される
6. クライアントにレスポンスが返される (ジョブ ID を含む)

### 6.2. 文書処理フロー

1. プロセッサーサービスが Redis キューからジョブを取得
2. MinIO から文書ファイルを取得
3. 文書タイプに応じたパーサーが実行される
4. パース結果が LangChain/LangGraph パイプラインに送られる
5. GPT-4o モデルがデータ抽出を実行
6. 抽出結果がバリデーターによって検証される
7. 検証済みデータがデータベースに保存される
8. ジョブステータスが更新される

### 6.3. データ取得フロー

1. クライアントが API サービスに抽出データを要求
2. API サービスが認証・認可を検証
3. データベースから対応する抽出データを取得
4. データが整形されてクライアントに返される

## 7. エラーコードと対応

### 7.1. クライアントエラー (4xx)

| コード | エラー名               | 説明                       | 対応                                            |
| ------ | ---------------------- | -------------------------- | ----------------------------------------------- |
| 400    | BAD_REQUEST            | 不正なリクエスト形式       | リクエストパラメータを確認                      |
| 401    | UNAUTHORIZED           | 認証情報が不足または無効   | 有効なトークンで再認証                          |
| 403    | FORBIDDEN              | アクセス権限がない         | 権限を確認                                      |
| 404    | NOT_FOUND              | リソースが見つからない     | リソース ID を確認                              |
| 413    | PAYLOAD_TOO_LARGE      | ファイルサイズが大きすぎる | ファイルサイズを 50MB 以下に縮小                |
| 415    | UNSUPPORTED_MEDIA_TYPE | サポート外のファイル形式   | Excel 形式 (.xlsx, .xls, .csv) のファイルを使用 |
| 429    | TOO_MANY_REQUESTS      | リクエスト頻度が高すぎる   | リクエスト頻度を下げる                          |

### 7.2. サーバーエラー (5xx)

| コード | エラー名              | 説明                                 | 対応                     |
| ------ | --------------------- | ------------------------------------ | ------------------------ |
| 500    | INTERNAL_SERVER_ERROR | 内部サーバーエラー                   | 管理者に問い合わせ       |
| 502    | BAD_GATEWAY           | 外部サービスとの通信エラー           | しばらく経ってから再試行 |
| 503    | SERVICE_UNAVAILABLE   | サービスが一時的に利用不可           | しばらく経ってから再試行 |
| 504    | GATEWAY_TIMEOUT       | 外部サービスからの応答がタイムアウト | しばらく経ってから再試行 |

### 7.3. ビジネスロジックエラー

| コード | エラー名                | 説明                    | 対応                                   |
| ------ | ----------------------- | ----------------------- | -------------------------------------- |
| B001   | INVALID_DOCUMENT_FORMAT | 文書形式が処理不可能    | 文書フォーマットを確認                 |
| B002   | EXTRACTION_FAILED       | データ抽出に失敗        | 文書内容を確認または管理者に問い合わせ |
| B003   | VALIDATION_FAILED       | データ検証に失敗        | 抽出データの検証エラーを確認           |
| B004   | MODEL_ERROR             | AI モデル呼び出しエラー | しばらく経ってから再試行               |
| B005   | QUOTA_EXCEEDED          | API 使用量制限超過      | 使用量を確認または管理者に問い合わせ   |

## 8. 制限事項

### 8.1. ファイル制限

- サポートするファイル形式: .xlsx, .xls, .csv
- 最大ファイルサイズ: 50MB
- 最大シート数: 20 シート
- 最大行数: 10,000 行 (シートあたり)
- 最大列数: 100 列

### 8.2. 処理制限

- 同時実行ジョブ数: 10 (デフォルト設定)
- ユーザーあたりの最大ジョブ数: 100/日
- 最大処理時間: 10 分 (ジョブあたり)
- リトライ回数: 3 回 (エラー時)

### 8.3. API 制限

- レート制限: 60 リクエスト/分 (ユーザーあたり)
- 最大ページサイズ: 1,000 アイテム
- トークン有効期限: 24 時間
- レスポンスタイムアウト: 30 秒

## 9. 対応ファイルフォーマットの詳細

### 9.1. Excel ファイル (.xlsx, .xls)

- Excel 97-2003 (.xls)
- Excel 2007 以降 (.xlsx)
- マクロ有効ブック (.xlsm) - マクロは実行されない
- 対応機能:
  - 複数シート
  - セル結合
  - 数式
  - 条件付き書式 (一部)
  - 名前付き範囲
  - テーブル

### 9.2. CSV ファイル (.csv)

- カンマ区切り (デフォルト)
- タブ区切り
- セミコロン区切り
- エンコーディング:
  - UTF-8 (推奨)
  - Shift-JIS
  - ISO-8859-1

## 10. システム組み込みガイドライン

### 10.1. 認証連携

- 社内認証基盤との連携方法
- 既存のシングルサインオンシステムとの統合
- API キーの管理と更新

### 10.2. データ連携

- 抽出データの他システムへの連携方法
- Webhook 設定によるイベント通知
- バッチ処理による一括データ転送

### 10.3. カスタマイズ

- 抽出ルールのカスタマイズ方法
- バリデーションルールの追加
- 新しい文書タイプへの対応方法

## 11. 結論

AI-OCR システムは、Excel 文書からの構造化データ抽出を自動化し、高精度で効率的な文書処理を実現します。本仕様書に定義された機能要件と非機能要件に基づいて実装され、社内リソースとして長期間にわたって価値を提供することを目指しています。

本システムは API 経由で他のシステムと連携可能であり、大量の文書処理を効率的に行うことができます。また、LangChain/LangGraph と GPT-4o などの最新の AI 技術を活用することで、従来の OCR システムよりも高度な文書理解と情報抽出を実現します。
