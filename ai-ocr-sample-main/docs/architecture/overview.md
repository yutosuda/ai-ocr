# AI-OCR システムアーキテクチャ概要

## 目的

AI-OCR システムは、非構造化文書（特に Microsoft Office Excel ファイル）から構造化データを抽出し、企業内の他システムで利用可能な形式で提供することを目的としています。最新の AI 技術（GPT-4o）、LangChain、LangGraph を活用して高精度な文書理解と情報抽出を実現します。

## システムアーキテクチャ

システムは以下の主要コンポーネントで構成されています：

```
┌────────────────┐     ┌────────────────┐     ┌────────────────┐
│                │     │                │     │                │
│   APIサービス   │◄────►   処理サービス   │◄────►  データベース  │
│    (FastAPI)   │     │  (LangChain)   │     │ (PostgreSQL)  │
│                │     │                │     │                │
└───────┬────────┘     └───────┬────────┘     └────────────────┘
        │                      │
        │                      │
        ▼                      ▼
┌────────────────┐     ┌────────────────┐
│                │     │                │
│  キャッシュ/キュー │     │ 文書ストレージ  │
│    (Redis)     │     │   (MinIO)     │
│                │     │                │
└────────────────┘     └────────────────┘
```

### 1. API サービス

- **技術**: FastAPI
- **役割**:
  - 文書アップロードエンドポイントの提供
  - 処理ジョブの管理
  - 抽出結果の取得インターフェース
  - 認証と認可の処理

API サービスはシステムのフロントエンドとして機能し、外部システムとの連携ポイントとなります。RESTful API を通じて、文書のアップロード、処理状況の確認、抽出データの取得などの機能を提供します。

### 2. 処理サービス

- **技術**: Python, LangChain, LangGraph, GPT-4o
- **役割**:
  - 文書の解析
  - 構造化データの抽出
  - 抽出データの検証
  - 結果の保存

処理サービスはシステムの中核となるコンポーネントで、アップロードされた文書を解析し、構造化データを抽出します。LangChain と LangGraph を使用して GPT-4o モデルと連携し、高度な文書理解を実現します。

### 3. データベース

- **技術**: PostgreSQL
- **役割**:
  - 文書メタデータの保存
  - 処理ジョブの状態管理
  - 抽出結果の保存

データベースはシステムの永続化層として機能し、文書情報、処理ジョブ、抽出結果などのデータを保存します。

### 4. キャッシュ/キュー

- **技術**: Redis
- **役割**:
  - 処理キューの管理
  - 一時データのキャッシュ
  - サービス間の非同期通信

Redis はシステム内の非同期処理と一時データストレージを担当します。処理ジョブのキューイングやサービス間の効率的な通信を可能にします。

### 5. 文書ストレージ

- **技術**: MinIO (S3 互換)
- **役割**:
  - 原文書の保存
  - 処理済み文書の保存

MinIO はオブジェクトストレージとして機能し、アップロードされた文書や処理済み文書の保存を担当します。

## データフロー

1. クライアントが API サービスを通じて文書をアップロード
2. API サービスが文書を MinIO に保存し、文書メタデータをデータベースに登録
3. API サービスが処理ジョブを Redis キューに追加
4. 処理サービスがキューからジョブを取得
5. 処理サービスが MinIO から文書を取得して処理
6. 処理サービスが LangChain/LangGraph と GPT-4o を使用してデータを抽出
7. 処理サービスが抽出データを検証
8. 処理サービスが抽出結果をデータベースに保存
9. クライアントが API サービスを通じて結果を取得

## 技術選定理由

### FastAPI

- 高パフォーマンスな非同期処理
- 自動ドキュメント生成機能
- Python エコシステムとの高い互換性
- 型検証による API の堅牢性

### PostgreSQL

- JSON/JSONB 型のサポート
- トランザクション処理
- 堅牢な拡張性
- 広範なエコシステム

### Redis

- 高速なキャッシュ機能
- 信頼性の高いメッセージングシステム
- Pub/Sub 機能
- 軽量かつ高性能

### MinIO

- S3 互換 API の提供
- コンテナ環境での動作の容易さ
- スケーラビリティ
- セキュアなアクセス制御

### LangChain/LangGraph

- LLM との統合を容易にするフレームワーク
- 複雑な処理フローの構築が可能
- モジュール式のコンポーネント設計
- 再利用可能なパターンのライブラリ

## スケーラビリティと耐障害性

### スケーリング戦略

- **水平スケーリング**: API サービスと処理サービスは水平スケーリングが可能
- **ロードバランシング**: トラフィックの均等な分散
- **キューベースのタスク分配**: 処理負荷の平準化

### 耐障害性の実現

- **サービス冗長化**: 単一障害点の排除
- **ヘルスチェック**: 定期的なサービス状態監視
- **自動リスタート**: 障害時の自動復旧
- **定期バックアップ**: データの定期的なバックアップ

## セキュリティ考慮事項

- **TLS 暗号化**: 通信の暗号化
- **認証と認可**: API アクセスの制限
- **データ暗号化**: 保存データの暗号化
- **監査ログ**: 操作の記録
- **最小権限の原則**: 各サービスに必要最小限の権限を付与

## デプロイメントと運用

システムは Docker ベースのコンテナ環境でデプロイされ、Docker Compose を使用して管理されます。これにより、環境間の一貫性と移植性が確保されます。

### 運用管理

- **モニタリング**: Prometheus を使用したメトリクス収集
- **ログ集約**: 集中ログ管理
- **アラート**: 異常時の通知
- **スケーリング**: 負荷に応じた自動スケーリング
